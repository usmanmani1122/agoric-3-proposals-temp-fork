jobs:
  create-snapshot:
    name: Create Mainfork Snapshot
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        id: get-proposal-count-difference
        name: Get Proposals Count Difference
        run: |
          #! /bin/bash
          set -o errexit -o errtrace -o xtrace

          echo "$GITHUB_CONTEXT"
          PRE=${{ github.event.before }}
          POST=${{ github.event.after }}
          PRE_LIST=$(git -C proposals ls-tree -d --name-only "$PRE")
          POST_LIST=$(git -C proposals ls-tree -d --name-only "$POST")

          # compute “dir in POST but not in PRE”
          # comm -13 requires sorted inputs
          NEW=$(comm -13 \
                  <(printf "%s\n" $PRE_LIST    | sort) \
                  <(printf "%s\n" $POST_LIST   | sort) \
                | wc -l)

          echo "DIFFERENCE=$NEW" >> $GITHUB_OUTPUT

name: Create Mainfork Snapshot

on:
  push:
    branches:
      - main
